<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Êï∞Áõ¥Á∑ö„Ç¢„Éó„É™</title>
  <style>
    /* --- CSS START --- */


    /* Âü∫Êú¨Ë®≠ÂÆö */
    body, html {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
      font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #fdfdfd; color: #333; user-select: none;
    }
    .app-container {
      display: flex; flex-direction: column; align-items: center; height: 90vh; width: 100%; position: relative; padding-top: 10px;
      transition: background-color 0.2s;
    }
    
    .urgent-pulse { animation: urgentBg 0.8s infinite alternate; }
    @keyframes urgentBg { 0% { box-shadow: inset 0 0 0px transparent; } 100% { box-shadow: inset 0 0 50px rgba(231, 76, 60, 0.5); } }

    .timer-urgent { color: #e74c3c !important; animation: pulseText 0.5s infinite alternate; }
    @keyframes pulseText { 0% { transform: scale(1); } 100% { transform: scale(1.2); } }

    .app-header { font-size: 1.2rem; font-weight: bold; color: #777; margin-bottom: 5px; }

    /* „É©„É≥„ÇØË°®Á§∫„Ç®„É™„Ç¢ */
    .global-rank-area { position: absolute; top: 5px; left: 10px; z-index: 60; display: flex; flex-direction: column; align-items: flex-start; pointer-events: none; }
    .rank-label { font-size: 0.8rem; font-weight: bold; color: #999; letter-spacing: 1px; margin-bottom: -5px; }
    .rank-text {
      font-size: clamp(2rem, 8vw, 3.5rem); font-weight: 900; font-family: 'Arial Black', sans-serif; color: #555;
      line-height: 1.1; text-shadow: 2px 2px 0px rgba(255,255,255,0.8); transition: all 0.3s;
    }
    .rank-beginner { color: #95a5a6; }
    .rank-B { color: #3498db; }
    .rank-A { color: #e67e22; }
    .rank-S { color: #e74c3c; text-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
    .rank-SS { color: #9b59b6; text-shadow: 0 0 10px rgba(155, 89, 182, 0.5); }
    .rank-SSS { background: linear-gradient(45deg, #f1c40f, #e67e22, #f39c12); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: none; filter: drop-shadow(0 0 5px rgba(243, 156, 18, 0.5)); }
    .rank-reset-mini { pointer-events: auto; margin-top: 5px; font-size: 0.7rem; background: #ccc; color: #fff; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; }
    .rank-reset-mini:hover { background: #999; }

    /* „Çµ„Ç¶„É≥„Éâ */
    .sound-control { position: absolute; top: 10px; right: 10px; z-index: 70; }
    .mute-btn { background: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; border-radius: 20px; padding: 5px 12px; font-size: 0.8rem; font-weight: bold; cursor: pointer; color: #555; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; }
    .mute-btn:active { transform: translateY(2px); }
    .mute-btn.muted { background: #eee; color: #999; text-decoration: line-through; }

    /* „Éä„Éì */
    .mode-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; background-color: #eee; padding: 5px; border-radius: 25px; }
    .nav-btn { background: transparent; border: none; padding: 8px 20px; border-radius: 20px; font-size: 1rem; font-weight: bold; color: #555; cursor: pointer; transition: all 0.2s; }
    .nav-btn.active { background-color: #fff; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #btn-mode-learning.active { color: #e67e22; border-bottom: 3px solid #e67e22; }
    #btn-mode-practice.active { color: #2ecc71; border-bottom: 3px solid #2ecc71; }
    #btn-mode-exam.active { color: #3498db; border-bottom: 3px solid #3498db; }

    .mode-ui { width: 100%; display: flex; flex-direction: column; align-items: center; }

    /* Â≠¶Áøí„ÉªÁ∑¥Áøí„ÉªÊ§úÂÆö ÂÖ±ÈÄö */
    .controls-wrapper { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; width: 95%; }
    .reference-control { display: flex; align-items: center; justify-content: center; background-color: #eee; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .ref-label { font-size: 1.5rem; margin-right: 15px; font-weight: bold; color: #444; }
    .ref-value { font-size: 2.5rem; font-weight: bold; color: #d32f2f; min-width: 50px; text-align: center; margin-right: 15px; line-height: 1; }
    .ref-buttons { display: flex; flex-direction: column; gap: 4px; }
    .ref-btn { background-color: #fff; border: 2px solid #ccc; border-radius: 6px; cursor: pointer; font-size: 0.9rem; width: 50px; height: 30px; display: flex; align-items: center; justify-content: center; }
    .ref-btn:active { background-color: #ddd; }
    .comparison-display { font-size: 1.5rem; font-weight: bold; color: #555; display: flex; align-items: baseline; gap: 8px; }
    .comp-value { font-size: 2.5rem; margin: 0 8px; font-weight: 800; }
    .tool-btn { padding: 10px 20px; font-size: 1rem; font-weight: bold; background-color: #fff; border: 2px solid #555; border-radius: 10px; cursor: pointer; color: #555; transition: all 0.2s; }
    .tool-btn.active { background-color: #555; color: #fff; }
    .display-section { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; min-height: 80px; }
    #number-display { font-weight: bold; color: #e67e22; font-size: clamp(3rem, 15vw, 6rem); }

    .problem-text { font-size: clamp(1.4rem, 4vw, 2.2rem); font-weight: bold; color: #333; }
    .problem-feedback { font-size: 1.5rem; font-weight: bold; color: #555; min-height: 30px; }
    .problem-feedback.correct { color: #2ecc71; font-size: 2.5rem; }
    .problem-feedback.incorrect { color: #e74c3c; }

    .practice-area { text-align: center; padding: 20px; background-color: #e8f5e9; border-radius: 20px; border: 3px solid #2ecc71; width: 90%; max-width: 800px; margin: 0 auto 20px auto; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
    .mode-title { font-size: 1rem; color: #2ecc71; font-weight: bold; letter-spacing: 2px; }
    .next-btn { background-color: #2ecc71; color: white; border-color: #27ae60; }

    .rank-status-bar { width: 90%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background-color: #fff; padding: 8px 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .best-rank-info { font-weight: bold; color: #555; font-size: 1rem; display: flex; align-items: center; gap: 10px; }
    .rank-badge { background-color: #333; color: #fff; padding: 2px 10px; border-radius: 5px; font-weight: 800; font-family: 'Arial Black', sans-serif; }
    
    .game-hud { display: flex; justify-content: space-around; width: 95%; max-width: 800px; margin: 0 auto 10px auto; background: #fff; padding: 10px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .hud-item { display: flex; flex-direction: column; align-items: center; }
    .hud-label { font-size: 0.8rem; font-weight: bold; color: #777; }
    .hud-value { font-size: 1.8rem; font-weight: 800; color: #333; font-family: 'Courier New', monospace; }
    #game-score { color: #e67e22; }
    #game-timer { color: #333; }
    #game-combo { color: #9b59b6; transition: transform 0.1s; }
    .combo-active { transform: scale(1.5); color: #8e44ad !important; }

    .exam-bg { text-align: center; padding: 15px; background-color: #fff8e1; border-radius: 20px; border: 3px solid #f1c40f; width: 90%; max-width: 800px; margin: 0 auto 20px auto; min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; transition: all 0.3s; }
    
    .bonus-mode {
      background-color: #fff3e0;
      border-color: #e67e22;
      box-shadow: 0 0 15px rgba(230, 126, 34, 0.5);
    }
    .bonus-mode .problem-text {
      color: #d35400;
      text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
    }
    .bonus-badge {
      display: inline-block;
      background: #e67e22;
      color: white;
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 4px;
      vertical-align: middle;
      margin-right: 5px;
      transform: translateY(-2px);
    }

    .slider-section { flex: 1; width: 95%; max-width: 1200px; display: flex; justify-content: center; align-items: flex-start; position: relative; margin-bottom: 20px; }
    .ruler-wrapper { position: relative; width: 100%; height: 120px; margin-top: 10px; }
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; position: absolute; top: 40px; left: 0; z-index: 20; margin: 0; cursor: pointer; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 44px; width: 44px; border-radius: 50%; background: #e67e22; border: 4px solid #fff; box-shadow: 0 3px 6px rgba(0,0,0,0.3); margin-top: -20px; }
    input[type=range]::-moz-range-thumb { height: 44px; width: 44px; border-radius: 50%; background: #e67e22; border: 4px solid #fff; box-shadow: 0 3px 6px rgba(0,0,0,0.3); }
    .ruler-ticks { position: absolute; top: 42px; left: 22px; right: 22px; height: 60px; pointer-events: none; border-top: 3px solid #333; }
    .tick { position: absolute; background-color: #333; width: 2px; transform: translateX(-50%); top: 0; }
    .tick.major { height: 20px; width: 3px; }
    .tick.minor { height: 10px; background-color: #777; }
    .tick-label { position: absolute; top: 25px; transform: translateX(-50%); font-size: 1.1rem; color: #333; font-weight: bold; user-select: none; pointer-events: none; padding: 12px; border-radius: 10px; transition: background-color 0.1s; }
    .ruler-ticks.interactive .tick-label { pointer-events: auto; cursor: pointer; background-color: rgba(255,255,255,0.7); box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 30; }
    .ruler-ticks.interactive .tick-label:active { background-color: #b2ebf2; transform: translateX(-50%) scale(0.9); }
    .reference-marker { position: absolute; top: 10px; bottom: 0; width: 6px; background-color: rgba(211, 47, 47, 0.6); transform: translateX(-50%); pointer-events: none; z-index: 5; left: 50%; transition: left 0.3s ease; display: flex; flex-direction: column; align-items: center; }
    .reference-marker::before { content: '‚ñº'; color: #d32f2f; font-size: 18px; margin-top: -18px; }
    .marker-label { font-size: 1rem; color: #d32f2f; font-weight: bold; margin-top: 80px; }
    .vector-arrow { position: absolute; top: 34px; height: 6px; z-index: 10; pointer-events: none; display: none; }
    .vector-arrow::after { content: ''; position: absolute; top: 50%; transform: translateY(-50%); border-style: solid; }
    .vector-arrow.positive { background-color: #e67e22; }
    .vector-arrow.positive::after { right: -10px; border-width: 8px 0 8px 12px; border-color: transparent transparent transparent #e67e22; }
    .vector-arrow.negative { background-color: #3498db; }
    .vector-arrow.negative::after { left: -10px; border-width: 8px 12px 8px 0; border-color: transparent #3498db transparent transparent; }
    .vector-label { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); background-color: rgba(255, 255, 255, 0.9); padding: 2px 6px; border-radius: 4px; font-size: 1.2rem; font-weight: bold; color: #333; white-space: nowrap; display: none; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .modal-content h2 { color: #e67e22; font-size: 2rem; margin-bottom: 15px; }
    .modal-btn-wrapper { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    .start-btn { background: #e67e22; color: white; border: none; padding: 12px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #d35400; transition: transform 0.1s; }
    .start-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #d35400; }
    .quit-btn { background: #95a5a6; color: white; border: none; padding: 12px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #7f8c8d; transition: transform 0.1s; }
    .quit-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #7f8c8d; }
    .result-score { font-size: 2.5rem; font-weight: bold; color: #333; margin: 10px 0; }
    .result-rank { font-size: 2rem; font-weight: bold; color: #e74c3c; font-family: 'Arial Black', sans-serif; }

    .cutin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 200; opacity: 0; transition: opacity 0.2s; }
    .cutin-text { font-size: 4rem; font-weight: 900; color: #fff; font-family: 'Arial Black', sans-serif; text-shadow: 0 0 20px rgba(255,215,0,0.8), 3px 3px 0 #e67e22; transform: scale(0); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .cutin-active { opacity: 1; }
    .cutin-active .cutin-text { transform: scale(1); }

    .effect-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 50; }
    .score-popup { position: absolute; font-size: 2rem; font-weight: bold; color: #e67e22; animation: fadeUp 1s forwards; text-shadow: 2px 2px 0 #fff; }
    .penalty-popup { position: absolute; font-size: 2.5rem; font-weight: bold; color: #e74c3c; animation: shakeFade 0.5s forwards; text-shadow: 2px 2px 0 #fff; }
    @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.2); } }
    @keyframes shakeFade { 0% { opacity: 1; transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 100% { opacity: 0; transform: translateY(-20px); } }
    .bg-red-flash { animation: flashRed 0.3s; }
    @keyframes flashRed { 0% { background-color: rgba(231, 76, 60, 0.3); } 100% { background-color: transparent; } }
    .footer-section { height: 10vh; display: flex; justify-content: center; align-items: center; background-color: #f0f0f0; font-size: 0.8rem; }


    /* --- CSS END --- */
  </style>
</head>
<body>
  <div id="app-container" class="app-container">
    
    <div id="global-rank-area" class="global-rank-area">
      <div class="rank-label">RANK</div>
      <div id="display-rank" class="rank-text">ÂàùÂøÉËÄÖ</div>
      <button id="btn-reset-rank" class="rank-reset-mini" style="display:none;">„É™„Çª„ÉÉ„Éà</button>
    </div>

    <div class="sound-control">
      <button id="btn-mute" class="mute-btn">üîä ON</button>
    </div>

    <div class="app-header">Êï∞Áõ¥Á∑ö„Ç¢„Éó„É™</div>

    <div class="mode-nav">
      <button id="btn-mode-learning" class="nav-btn active">Â≠¶Áøí</button>
      <button id="btn-mode-practice" class="nav-btn">Á∑¥Áøí</button>
      <button id="btn-mode-exam" class="nav-btn">Ê§úÂÆö</button>
    </div>

    <div id="ui-learning" class="mode-ui">
      <div class="controls-wrapper">
        <div class="reference-control">
          <span class="ref-label">Âü∫Ê∫ñ</span>
          <span id="ref-value" class="ref-value">0</span>
          <div class="ref-buttons">
            <button id="btn-up" class="ref-btn">‚ñ≤</button>
            <button id="btn-down" class="ref-btn">‚ñº</button>
          </div>
        </div>
        <div class="comparison-display">
          <span class="comp-static">„Çà„Çä</span>
          <span id="comp-diff-value" class="comp-value">0</span>
          <span id="comp-diff-text" class="comp-text">ÔºàÂêå„ÅòÔºâ</span>
        </div>
        <button id="btn-toggle-abs" class="tool-btn">Áµ∂ÂØæÂÄ§„ÇíË°®Á§∫</button>
      </div>

      <div class="display-section">
        <div id="number-display">0.0</div>
      </div>
    </div>

    <div id="ui-practice" class="mode-ui" style="display:none;">
      <div class="practice-area">
        <div class="mode-title">Á∑¥Áøí„É¢„Éº„Éâ</div>
        <div id="practice-text" class="problem-text">Ê∫ñÂÇô‰∏≠...</div>
        <div id="practice-feedback" class="problem-feedback">„É°„É¢„É™„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂõûÁ≠î</div>
        <button id="btn-next-practice" class="tool-btn next-btn" style="display:none;">Ê¨°„ÅÆÂïèÈ°å„Å∏</button>
      </div>
    </div>

    <div id="ui-exam" class="mode-ui" style="display:none;">
      
      <div class="rank-status-bar">
        <div class="best-rank-info">
          „ÅÇ„Å™„Åü„ÅÆÊúÄÈ´ò„É©„É≥„ÇØ: <span id="current-best-rank" class="rank-badge">-</span>
        </div>
      </div>

      <div class="game-hud">
        <div class="hud-item">
          <span class="hud-label">SCORE</span>
          <span id="game-score" class="hud-value">0</span>
        </div>
        <div class="hud-item timer-box">
          <span class="hud-label">TIME</span>
          <span id="game-timer" class="hud-value">30.0</span>
        </div>
        <div class="hud-item">
          <span class="hud-label">COMBO</span>
          <span id="game-combo" class="hud-value combo-zero">0</span>
        </div>
      </div>

      <div id="exam-problem-area" class="problem-area exam-bg">
        <div id="exam-text" class="problem-text">Ê∫ñÂÇô‰∏≠...</div>
        <div id="exam-feedback" class="problem-feedback">„É°„É¢„É™„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂõûÁ≠î</div>
      </div>
    </div>

    <div class="slider-section">
      <div class="ruler-wrapper">
        <div id="ruler-ticks" class="ruler-ticks"></div>
        
        <div id="vector-arrow" class="vector-arrow">
          <div id="vector-label" class="vector-label"></div>
        </div>

        <div id="reference-marker" class="reference-marker">
            <div class="marker-label">Âü∫Ê∫ñ</div>
        </div>

        <input type="range" id="number-slider" min="-10" max="10" step="0.1" value="0">
      </div>
    </div>
  </div>

  <div id="game-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h2 id="modal-title">Êï∞Áõ¥Á∑ö„Éû„Çπ„Çø„ÉºÊ§úÂÆö</h2>
      <div id="modal-body">
        <p>Âà∂ÈôêÊôÇÈñì„ÅØ30ÁßíÔºÅ</p>
        <p>Ê≠£Ëß£„Åß„Ç≥„É≥„Éú„Éú„Éº„Éä„Çπ„ÄÅÈñìÈÅï„Åà„Çã„Å®-2Áßí„ÄÇ</p>
        <p style="color:#e67e22; font-weight:bold; margin-top:10px;">‚òÖ0„Åæ„Åü„ÅéÂïèÈ°å„ÅØÂæóÁÇπ1.2ÂÄçÔºÅ</p>
      </div>
      <div id="result-area" style="display:none;">
        <div class="result-score">Score: <span id="result-score-val">0</span></div>
        <div class="result-rank">Rank: <span id="result-rank-val">-</span></div>
      </div>
      
      <div class="modal-btn-wrapper">
        <button id="btn-exam-back" class="quit-btn">Á∑¥Áøí„Å´Êàª„Çã</button>
        <button id="btn-game-quit" class="quit-btn" style="display:none;">„ÇÑ„ÇÅ„Çã</button>
        <button id="btn-game-start" class="start-btn">„Çπ„Çø„Éº„ÉàÔºÅ</button>
      </div>
    </div>
  </div>
  
  <div id="cutin-overlay" class="cutin-overlay">
    <div id="cutin-text" class="cutin-text">RANK A Âà∞ÈÅî!!</div>
  </div>

  <div id="effect-layer" class="effect-layer"></div>

  <div class="footer-section">
    <footer style="margin-top:50px; padding:20px; text-align:center; border-top:1px solid #eee; background-color:#fafafa;">
     <a href="https://sites.google.com/view/k-system-lab/„Éõ„Éº„É†" target="_blank" style="color:#007bff; text-decoration:none; font-weight:bold;">
       üè† K-System Lab („Éõ„Éº„É†) „Å´Êàª„Çã
     </a>
   </footer>
  </div>

  <script>
    /* --- JS START --- */


    class AudioController {
      constructor() {
        this.ctx = null;
        this.isMuted = false;
      }
      init() {
        if (!this.ctx) {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          this.ctx = new AudioContext();
        } else if (this.ctx.state === 'suspended') {
          this.ctx.resume();
        }
      }
      toggleMute() { this.isMuted = !this.isMuted; return this.isMuted; }
      playTone(freq, type, duration, startTime = 0) {
        if (this.isMuted || !this.ctx) return;
        try {
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
          gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
          gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + startTime + duration);
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start(this.ctx.currentTime + startTime);
          osc.stop(this.ctx.currentTime + startTime + duration);
        } catch(e) { console.error(e); }
      }
      playCorrect() {
        this.init();
        this.playTone(880, 'sine', 0.1, 0); 
        this.playTone(1760, 'sine', 0.2, 0.1); 
      }
      playIncorrect() {
        this.init();
        this.playTone(150, 'sawtooth', 0.3, 0);
        this.playTone(130, 'sawtooth', 0.3, 0.1);
      }
      playCombo(comboCount) {
        this.init();
        const baseFreq = 500 + (comboCount * 50);
        this.playTone(baseFreq, 'triangle', 0.1, 0);
        this.playTone(baseFreq * 1.5, 'triangle', 0.2, 0.05);
      }
      playRankUp() {
        this.init();
        this.playTone(523.25, 'square', 0.1, 0); 
        this.playTone(659.25, 'square', 0.1, 0.1); 
        this.playTone(783.99, 'square', 0.1, 0.2); 
        this.playTone(1046.50, 'square', 0.4, 0.3); 
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const audioCtrl = new AudioController();

      // DOMË¶ÅÁ¥†„ÅÆÂèñÂæóÔºànull„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å™„Åå„Çâ‰Ωø„ÅÜ„Åü„ÇÅÂ§âÊï∞ÂåñÔºâ
      // ÂÆâÂÖ®„ÅÆ„Åü„ÇÅ .app-container „ÇØ„É©„Çπ„Åß„ÇÇÂèñÂæó„ÇíË©¶„Åø„Çã
      const appContainer = document.getElementById('app-container') || document.querySelector('.app-container');
      const cutinOverlay = document.getElementById('cutin-overlay');
      const cutinText = document.getElementById('cutin-text');
      const examProblemArea = document.getElementById('exam-problem-area');

      const slider = document.getElementById('number-slider');
      const display = document.getElementById('number-display');
      const rulerContainer = document.getElementById('ruler-ticks');
      const refDisplay = document.getElementById('ref-value');
      const refMarker = document.getElementById('reference-marker');
      const btnUp = document.getElementById('btn-up');
      const btnDown = document.getElementById('btn-down');
      const compDiffValue = document.getElementById('comp-diff-value');
      const compDiffText = document.getElementById('comp-diff-text');
      const vectorArrow = document.getElementById('vector-arrow');
      const btnToggleAbs = document.getElementById('btn-toggle-abs');
      const vectorLabel = document.getElementById('vector-label');
      
      const displayRank = document.getElementById('display-rank');
      const btnResetRank = document.getElementById('btn-reset-rank');
      const btnMute = document.getElementById('btn-mute'); 

      const btnModeLearning = document.getElementById('btn-mode-learning');
      const btnModePractice = document.getElementById('btn-mode-practice');
      const btnModeExam = document.getElementById('btn-mode-exam');
      const uiLearning = document.getElementById('ui-learning');
      const uiPractice = document.getElementById('ui-practice');
      const uiExam = document.getElementById('ui-exam');
      
      const practiceText = document.getElementById('practice-text');
      const practiceFeedback = document.getElementById('practice-feedback');
      const btnNextPractice = document.getElementById('btn-next-practice');

      const gameScoreEl = document.getElementById('game-score');
      const gameTimerEl = document.getElementById('game-timer');
      const gameComboEl = document.getElementById('game-combo');
      const examText = document.getElementById('exam-text');
      const examFeedback = document.getElementById('exam-feedback');
      const effectLayer = document.getElementById('effect-layer');
      const currentBestRankEl = document.getElementById('current-best-rank');
      
      const gameModal = document.getElementById('game-modal');
      const btnGameStart = document.getElementById('btn-game-start');
      const btnGameQuit = document.getElementById('btn-game-quit'); 
      const btnExamBack = document.getElementById('btn-exam-back'); 
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');
      const resultArea = document.getElementById('result-area');
      const resultScoreVal = document.getElementById('result-score-val');
      const resultRankVal = document.getElementById('result-rank-val');

      const minVal = -10;
      const maxVal = 10;
      
      let currentMode = 'learning'; 
      let referenceVal = 0; 
      let isAbsVisible = false;

      let currentProblem = null; 
      let score = 0;
      let combo = 0;
      let timeLeft = 30.0;
      let timerInterval = null;
      let isGameActive = false;
      let isPracticeSolved = false;

      let currentRunMaxRank = 0; 
      let bestRank = null; 
      const rankOrder = { '-': 0, 'C': 1, 'B': 2, 'A': 3, 'S': 4, 'SS': 5, 'SSS': 6 };

      init();

      function init() {
        generateRuler();
        updateReferenceUI(); 
        updateGlobalRankDisplay(); 
        
        document.body.addEventListener('click', () => audioCtrl.init(), { once: true });
        document.body.addEventListener('touchstart', () => audioCtrl.init(), { once: true });
      }

      btnModeLearning.addEventListener('click', () => switchMode('learning'));
      btnModePractice.addEventListener('click', () => switchMode('practice'));
      btnModeExam.addEventListener('click', () => switchMode('exam'));

      slider.addEventListener('input', function() {
        if (currentMode === 'learning') {
          updateDisplay(this.value);
          updateComparisonInfo(); 
        }
      });

      btnUp.addEventListener('click', () => { if(referenceVal < maxVal) { referenceVal++; updateReferenceUI(); } });
      btnDown.addEventListener('click', () => { if(referenceVal > minVal) { referenceVal--; updateReferenceUI(); } });
      btnToggleAbs.addEventListener('click', function() {
        isAbsVisible = !isAbsVisible;
        this.textContent = isAbsVisible ? 'Áµ∂ÂØæÂÄ§„ÇíÈö†„Åô' : 'Áµ∂ÂØæÂÄ§„ÇíË°®Á§∫';
        if(isAbsVisible) this.classList.add('active'); else this.classList.remove('active');
        updateComparisonInfo();
      });

      btnNextPractice.addEventListener('click', () => generateProblem('practice'));

      btnGameStart.addEventListener('click', function() {
        gameModal.style.display = 'none';
        if (currentMode === 'exam') startExamGame();
      });
      
      btnExamBack.addEventListener('click', function() {
        gameModal.style.display = 'none';
        switchMode('practice');
      });

      btnGameQuit.addEventListener('click', function() {
         gameModal.style.display = 'none';
         switchMode('practice');
      });
      
      btnResetRank.addEventListener('click', function() {
        if(confirm('ÊúÄÈ´ò„É©„É≥„ÇØ„ÅÆË®òÈå≤„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
          bestRank = null;
          updateGlobalRankDisplay();
        }
      });

      btnMute.addEventListener('click', function() {
        const isMuted = audioCtrl.toggleMute();
        if (isMuted) {
          this.textContent = 'üîá OFF'; this.classList.add('muted');
        } else {
          this.textContent = 'üîä ON'; this.classList.remove('muted');
        }
      });

      function switchMode(mode) {
        currentMode = mode;
        
        uiLearning.style.display = (mode === 'learning') ? 'block' : 'none';
        uiPractice.style.display = (mode === 'practice') ? 'block' : 'none';
        uiExam.style.display = (mode === 'exam') ? 'flex' : 'none';
        
        btnModeLearning.classList.toggle('active', mode === 'learning');
        btnModePractice.classList.toggle('active', mode === 'practice');
        btnModeExam.classList.toggle('active', mode === 'exam');

        slider.style.display = (mode === 'learning') ? 'block' : 'none';
        vectorArrow.style.display = (mode === 'learning' && slider.value != referenceVal) ? 'block' : 'none'; 
        
        // Ê§úÂÆö„É¢„Éº„Éâ„ÅÆÊôÇ„Å†„ÅëÂü∫Ê∫ñ„Éû„Éº„Ç´„Éº„ÇíÊ∂à„Åô
        if (mode === 'exam') {
          refMarker.style.display = 'none';
        } else {
          refMarker.style.display = 'flex';
        }
        
        if (mode === 'learning') {
          rulerContainer.classList.remove('interactive');
          updateReferenceUI();
        } else {
          rulerContainer.classList.add('interactive');
          vectorArrow.style.display = 'none'; 
          
          if (mode === 'practice') {
            generateProblem('practice');
          } else if (mode === 'exam') {
            showStartModal();
          }
        }
        // ÂÆâÂÖ®„Å´„ÇØ„É©„ÇπÂâäÈô§
        if(appContainer) appContainer.classList.remove('urgent-pulse');
      }

      function generateProblem(modeType) {
        if (modeType === 'exam' && !isGameActive) return;

        const forceZeroCrossing = (modeType === 'exam' && Math.random() < 0.4);
        let isBonusQuestion = false;
        let ref, diff, isPlus, answer;

        if (forceZeroCrossing) {
          isBonusQuestion = true;
          do {
            ref = Math.floor(Math.random() * 17) - 8;
          } while (ref === 0);

          if (ref < 0) {
            answer = Math.floor(Math.random() * 10) + 1;
          } else {
            answer = -(Math.floor(Math.random() * 10) + 1);
          }
          
          const move = answer - ref;
          diff = Math.abs(move);
          isPlus = (move > 0);

        } else {
          ref = Math.floor(Math.random() * 14) - 7; 
          diff = Math.floor(Math.random() * 5) + 1;
          isPlus = Math.random() > 0.5;
          answer = isPlus ? ref + diff : ref - diff;
          
          if (answer > maxVal || answer < minVal) {
             isPlus = !isPlus;
             answer = isPlus ? ref + diff : ref - diff;
             if (answer > maxVal || answer < minVal) {
                 ref = 0; diff = 3; isPlus = true; answer = 3; 
             }
          }
        }

        currentProblem = { ref: ref, diff: diff, isPlus: isPlus, answer: answer, isBonus: isBonusQuestion };

        const dirText = currentProblem.isPlus ? 'Â§ß„Åç„ÅÑ' : 'Â∞è„Åï„ÅÑ';
        let problemHTML = `Âü∫Ê∫ñ <span style="color:#d32f2f;">${currentProblem.ref}</span> „Çà„Çä <span style="color:#333;">${currentProblem.diff}</span> ${dirText}Êï∞„ÅØÔºü`;
        
        if (isBonusQuestion && modeType === 'exam') {
          problemHTML = `<span class="bonus-badge">BONUS!</span>` + problemHTML;
        }

        if (modeType === 'practice') {
          isPracticeSolved = false;
          practiceText.innerHTML = problemHTML;
          practiceFeedback.textContent = "„É°„É¢„É™„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÂõûÁ≠î";
          practiceFeedback.className = 'problem-feedback';
          btnNextPractice.style.display = 'none';
        } else {
          examText.innerHTML = problemHTML;
          examFeedback.textContent = "ÂõûÁ≠îÂæÖÊ©ü‰∏≠...";
          
          // ÂÆâÂÖ®„Å´„ÇØ„É©„ÇπÂàá„ÇäÊõø„Åà
          if (examProblemArea) {
            if (isBonusQuestion) {
              examProblemArea.classList.add('bonus-mode');
            } else {
              examProblemArea.classList.remove('bonus-mode');
            }
          }
        }

        moveReferenceMarker(Number(currentProblem.ref));
      }

      function checkAnswer(clickedVal) {
        const userAns = parseInt(clickedVal);

        if (currentMode === 'practice') {
          if (isPracticeSolved) return;
          if (userAns === currentProblem.answer) {
            isPracticeSolved = true;
            audioCtrl.playCorrect();
            practiceFeedback.textContent = 'Ê≠£Ëß£ÔºÅÔºÅ';
            practiceFeedback.className = 'problem-feedback correct';
            btnNextPractice.style.display = 'inline-block';
          } else {
            audioCtrl.playIncorrect();
            practiceFeedback.textContent = '„Åä„Åó„ÅÑÔºÅ';
            practiceFeedback.className = 'problem-feedback incorrect';
          }

        } else if (currentMode === 'exam') {
          if (!isGameActive) return;
          if (userAns === currentProblem.answer) {
            const bonus = combo * 2;
            let pts = 10 + bonus;
            
            if (currentProblem && currentProblem.isBonus) {
              pts = Math.floor(pts * 1.2);
            }

            score += pts;
            combo++;
            
            if(combo > 1) {
               audioCtrl.playCombo(combo);
            } else {
               audioCtrl.playCorrect();
            }

            showPopup(`+${pts}`, true);
            gameComboEl.classList.remove('combo-active');
            void gameComboEl.offsetWidth; 
            gameComboEl.classList.add('combo-active');
            
            checkRankUpdate();
            generateProblem('exam');
          } else {
            audioCtrl.playIncorrect();
            
            timeLeft -= 2.0;
            combo = 0; 
            showPopup(`-2Áßí`, false);
            document.body.classList.add('bg-red-flash');
            setTimeout(() => document.body.classList.remove('bg-red-flash'), 300);
          }
          updateHUD();
        }
      }

      function showStartModal() {
        gameModal.style.display = 'flex';
        modalTitle.textContent = 'Êï∞Áõ¥Á∑ö„Éû„Çπ„Çø„ÉºÊ§úÂÆö';
        modalBody.style.display = 'block';
        resultArea.style.display = 'none';
        
        btnGameStart.textContent = '„Çπ„Çø„Éº„ÉàÔºÅ';
        btnGameQuit.style.display = 'none'; 
        btnExamBack.style.display = 'inline-block'; 
      }

      function startExamGame() {
        score = 0;
        combo = 0;
        timeLeft = 30.0;
        currentRunMaxRank = 0; 
        isGameActive = true;
        audioCtrl.init(); 
        updateHUD();
        generateProblem('exam');
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateExamTimer, 100);
        
        if(appContainer) appContainer.classList.remove('urgent-pulse');
        gameTimerEl.classList.remove('timer-urgent');
      }

      function updateExamTimer() {
        timeLeft -= 0.1;
        
        // ‚òÖÂÆâÂÖ®„Å´„Ç®„Éï„Çß„ÇØ„ÉàÈÅ©Áî®ÔºàË¶ÅÁ¥†„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁÑ°Ë¶ñÔºâ
        if (timeLeft <= 5.0 && timeLeft > 0) {
          if(appContainer) appContainer.classList.add('urgent-pulse');
          gameTimerEl.classList.add('timer-urgent');
        } else {
          if(appContainer) appContainer.classList.remove('urgent-pulse');
          gameTimerEl.classList.remove('timer-urgent');
        }

        if (timeLeft <= 0) {
          timeLeft = 0;
          endExamGame();
        }
        gameTimerEl.textContent = timeLeft.toFixed(1);
      }

      function checkRankUpdate() {
        let currentRankStr = 'C';
        if (score >= 500) currentRankStr = 'SSS';
        else if (score >= 400) currentRankStr = 'SS';
        else if (score >= 300) currentRankStr = 'S';
        else if (score >= 200) currentRankStr = 'A';
        else if (score >= 100) currentRankStr = 'B';
        
        const rankVal = rankOrder[currentRankStr];
        
        if (rankVal > currentRunMaxRank && rankVal >= 3) { 
          currentRunMaxRank = rankVal;
          showCutin(`RANK ${currentRankStr} Âà∞ÈÅî!!`);
          audioCtrl.playRankUp();
        }
      }

      function showCutin(text) {
        if(!cutinText || !cutinOverlay) return; // ÂÆâÂÖ®Á≠ñ
        cutinText.textContent = text;
        cutinOverlay.classList.add('cutin-active');
        setTimeout(() => {
          cutinOverlay.classList.remove('cutin-active');
        }, 1500);
      }

      function endExamGame() {
        isGameActive = false;
        clearInterval(timerInterval);
        gameTimerEl.textContent = "0.0";
        
        let rank = 'C';
        if (score >= 500) rank = 'SSS';
        else if (score >= 400) rank = 'SS';
        else if (score >= 300) rank = 'S';
        else if (score >= 200) rank = 'A';
        else if (score >= 100) rank = 'B';
        
        const rankVal = rankOrder[rank];
        const currentBestVal = bestRank ? rankOrder[bestRank] : 0;
        if (rankVal > currentBestVal) {
          bestRank = rank;
          updateGlobalRankDisplay(); 
        }
        
        modalTitle.textContent = 'ÁµÇ‰∫ÜÔºÅ';
        modalBody.style.display = 'none';
        resultArea.style.display = 'block';
        resultScoreVal.textContent = score;
        resultRankVal.textContent = rank;
        
        btnGameStart.textContent = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶';
        btnExamBack.style.display = 'none'; 
        btnGameQuit.style.display = 'inline-block'; 
        
        gameModal.style.display = 'flex';
      }
      
      function updateGlobalRankDisplay() {
        displayRank.className = 'rank-text';
        
        if (!bestRank) {
          displayRank.textContent = 'ÂàùÂøÉËÄÖ';
          displayRank.classList.add('rank-beginner');
          btnResetRank.style.display = 'none';
          currentBestRankEl.textContent = '-';
          currentBestRankEl.style.backgroundColor = '#333';
        } else {
          displayRank.textContent = bestRank;
          displayRank.classList.add(`rank-${bestRank}`); 
          btnResetRank.style.display = 'block';
          currentBestRankEl.textContent = bestRank;
          
          if (bestRank === 'SSS') currentBestRankEl.style.backgroundColor = '#d4af37'; 
          else if (bestRank === 'SS') currentBestRankEl.style.backgroundColor = '#9b59b6';
          else if (bestRank === 'S') currentBestRankEl.style.backgroundColor = '#e74c3c';
          else if (bestRank === 'A') currentBestRankEl.style.backgroundColor = '#e67e22';
          else if (bestRank === 'B') currentBestRankEl.style.backgroundColor = '#3498db';
          else currentBestRankEl.style.backgroundColor = '#333';
        }
      }
      
      function updateHUD() {
        gameScoreEl.textContent = score;
        gameComboEl.textContent = combo;
        if(combo > 0) gameComboEl.style.color = '#e67e22'; else gameComboEl.style.color = '#777';
      }

      function showPopup(text, isGood) {
        if(!effectLayer) return; // ÂÆâÂÖ®Á≠ñ
        const el = document.createElement('div');
        el.textContent = text;
        el.className = isGood ? 'score-popup' : 'penalty-popup';
        const x = 50 + (Math.random() * 20 - 10);
        const y = 40 + (Math.random() * 10 - 5);
        el.style.left = x + '%'; el.style.top = y + '%';
        effectLayer.appendChild(el);
        setTimeout(() => el.remove(), 1000);
      }

      function updateReferenceUI() {
        refDisplay.textContent = referenceVal;
        slider.value = referenceVal;
        updateDisplay(referenceVal);
        moveReferenceMarker(referenceVal);
        updateComparisonInfo();
      }
      
      function moveReferenceMarker(val) {
        const numVal = Number(val);
        const totalRange = maxVal - minVal;
        const percent = ((numVal - minVal) / totalRange) * 100;
        refMarker.style.left = `calc(22px + (100% - 44px) * ${percent / 100})`;
      }

      function updateDisplay(val) {
        const num = parseFloat(val).toFixed(1);
        display.textContent = num;
        if (num < 0) display.style.color = '#3498db'; else display.style.color = '#e67e22'; 
      }
      
      function updateComparisonInfo() {
        const currentVal = parseFloat(slider.value);
        const diff = currentVal - referenceVal;
        const absDiff = Math.abs(diff).toFixed(1);
        
        compDiffValue.textContent = absDiff;
        if (diff > 0) { compDiffText.textContent = 'Â§ß„Åç„ÅÑ'; compDiffValue.style.color = '#e67e22'; }
        else if (diff < 0) { compDiffText.textContent = 'Â∞è„Åï„ÅÑ'; compDiffValue.style.color = '#3498db'; }
        else { compDiffValue.textContent = '0'; compDiffText.textContent = 'ÔºàÂêå„ÅòÔºâ'; compDiffValue.style.color = '#333'; }

        updateArrow(currentVal, diff, absDiff);
      }

      function updateArrow(currentVal, diff, absDiff) {
        if (diff === 0) { vectorArrow.style.display = 'none'; return; }
        vectorArrow.style.display = 'block';

        const totalRange = maxVal - minVal;
        const refPercent = ((referenceVal - minVal) / totalRange) * 100;
        const curPercent = ((currentVal - minVal) / totalRange) * 100;
        const widthPercent = Math.abs(curPercent - refPercent);
        let leftPercent;
        
        if (diff > 0) { leftPercent = refPercent; vectorArrow.className = 'vector-arrow positive'; } 
        else { leftPercent = curPercent; vectorArrow.className = 'vector-arrow negative'; }

        vectorArrow.style.width = `calc((100% - 44px) * ${widthPercent / 100})`;
        vectorArrow.style.left = `calc(22px + (100% - 44px) * ${leftPercent / 100})`;

        if (isAbsVisible) { vectorLabel.style.display = 'block'; vectorLabel.textContent = `Áµ∂ÂØæÂÄ§ ${absDiff}`; } 
        else { vectorLabel.style.display = 'none'; }
      }

      function generateRuler() {
        rulerContainer.innerHTML = ''; 
        for (let i = minVal; i <= maxVal; i++) { createTick(i, 'major'); }
        for (let i = minVal; i < maxVal; i++) { createTick(i + 0.5, 'minor'); }
      }

      function createTick(value, type) {
        const totalRange = maxVal - minVal;
        const percent = ((value - minVal) / totalRange) * 100;
        const tick = document.createElement('div');
        tick.className = `tick ${type}`;
        tick.style.left = `${percent}%`;
        rulerContainer.appendChild(tick);

        if (type === 'major') {
          const label = document.createElement('div');
          label.className = 'tick-label';
          label.textContent = value;
          label.style.left = `${percent}%`;
          
          label.addEventListener('click', function(e) {
            if (currentMode !== 'learning') {
              e.stopPropagation();
              checkAnswer(value);
            }
          });
          rulerContainer.appendChild(label);
        }
      }
      
      window.addEventListener('resize', function() {
         if (currentMode === 'learning') { moveReferenceMarker(referenceVal); updateComparisonInfo(); } 
         else if (currentProblem) { moveReferenceMarker(currentProblem.ref); }
      });
    });


    /* --- JS END --- */
  </script>

</body>
</html>
